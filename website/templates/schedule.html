{% extends 'base.html' %}

{% block content %}
<div class="fade-in h-full flex flex-col">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-xl font-bold text-white tracking-tight">Maintenance Calendar</h2>
            <p class="text-xs text-slate-400 mt-0.5">Plan and visualize your team's workload</p>
        </div>
        
        <div class="flex items-center bg-slate-800 rounded-lg p-1 border border-slate-700 shadow-lg">
            <button onclick="changeMonth(-1)" class="p-2 w-9 h-9 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 rounded transition"><i class="fas fa-chevron-left"></i></button>
            <span id="currentMonthDisplay" class="text-white font-semibold text-sm w-32 text-center select-none">December 2025</span>
            <button onclick="changeMonth(1)" class="p-2 w-9 h-9 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 rounded transition"><i class="fas fa-chevron-right"></i></button>
        </div>

        <button onclick="openModal(new Date().toISOString().split('T')[0])" class="bg-violet-600 hover:bg-violet-700 text-white px-3 py-2 rounded-lg flex items-center gap-2 text-xs font-medium shadow-lg transition-all">
            <i class="fas fa-plus"></i> Schedule Job
        </button>
    </div>

    <div class="glass-panel rounded-xl border border-slate-700 flex flex-col flex-1 overflow-hidden shadow-2xl">
        <div class="grid grid-cols-7 bg-slate-800/80 border-b border-slate-700 text-center">
            <div class="py-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Sun</div>
            <div class="py-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Mon</div>
            <div class="py-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Tue</div>
            <div class="py-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Wed</div>
            <div class="py-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Thu</div>
            <div class="py-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Fri</div>
            <div class="py-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Sat</div>
        </div>

        <div id="calendarGrid" class="grid grid-cols-7 grid-rows-5 flex-1 bg-slate-900/50 divide-x divide-slate-800 divide-y">
            </div>
    </div>
</div>

<div id="scheduleModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity duration-300">
    <div class="bg-[#0f172a] rounded-xl border border-slate-700 w-full max-w-md shadow-2xl transform scale-100 transition-transform">
        <div class="flex justify-between items-center p-4 border-b border-slate-800">
            <h3 class="text-sm font-bold text-white">Schedule Maintenance</h3>
            <button onclick="closeModal()" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-5 space-y-4">
            
            <div class="bg-violet-500/10 border border-violet-500/20 p-3 rounded-lg flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-violet-600 flex items-center justify-center text-white"><i class="far fa-calendar-alt"></i></div>
                <div>
                    <p class="text-[10px] text-violet-300 uppercase font-bold">Selected Date</p>
                    <p id="modalDateText" class="text-sm font-bold text-white">Dec 27, 2025</p>
                </div>
            </div>

            <form class="space-y-3">
                <input type="text" placeholder="Task Subject (e.g. Pump Service)" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-white text-xs focus:outline-none focus:border-violet-500">
                <select class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-white text-xs focus:outline-none focus:border-violet-500">
                    <option>Select Equipment...</option>
                    <option>CNC Machine #3</option>
                    <option>Belt Conveyor A</option>
                </select>
                <div class="flex gap-4 pt-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="type" checked class="accent-sky-500">
                        <span class="text-xs text-slate-300">Preventive</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="type" class="accent-rose-500">
                        <span class="text-xs text-slate-300">Corrective</span>
                    </label>
                </div>
            </form>
        </div>
        <div class="p-4 border-t border-slate-800 flex justify-end gap-2 bg-slate-900/50 rounded-b-xl">
            <button onclick="closeModal()" class="px-4 py-2 text-xs font-medium text-slate-300 hover:text-white">Cancel</button>
            <button class="px-4 py-2 text-xs font-medium text-white bg-violet-600 hover:bg-violet-700 rounded shadow-lg shadow-violet-900/20">Confirm Schedule</button>
        </div>
    </div>
</div>

<style>
    /* Specific overrides for the calendar grid */
    .cal-cell { min-height: 100px; transition: background 0.2s; position: relative; }
    .cal-cell:hover { background: rgba(30, 41, 59, 0.5); }
    .cal-today { background: rgba(124, 58, 237, 0.05); }
    .cal-today span.day-num { background: #7c3aed; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
</style>

<script>
    let currentDate = new Date();
    let events = [];

    // 1. Initialize
    document.addEventListener('DOMContentLoaded', () => {
        fetchEvents();
    });

    // 2. Fetch Data from Backend
    async function fetchEvents() {
        try {
            // In a real app, fetch from API. 
            // For now, I'll mock the data format that your API would return.
            const response = await fetch('/api/calendar-events'); 
            // Fallback if API isn't ready yet:
            if(!response.ok) {
                 events = [
                    { date: '2025-12-05', title: 'Oil Check', type: 'Preventive' },
                    { date: '2025-12-24', title: 'Belt Fix', type: 'Corrective' },
                    { date: '2025-12-28', title: 'Calibration', type: 'Preventive' }
                ];
            } else {
                events = await response.json();
            }
            renderCalendar();
        } catch (e) {
            console.log("Using dummy data for demo");
            events = [
                { date: '2025-12-05', title: 'Oil Check', type: 'Preventive' },
                { date: '2025-12-24', title: 'Belt Fix', type: 'Corrective' },
                { date: '2025-12-28', title: 'Calibration', type: 'Preventive' }
            ];
            renderCalendar();
        }
    }

    // 3. Render Logic (The Brains)
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const monthDisplay = document.getElementById('currentMonthDisplay');
        
        grid.innerHTML = ''; // Clear previous
        
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        
        // Update Header
        const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        monthDisplay.innerText = `${monthNames[month]} ${year}`;

        // Calculations
        const firstDayIndex = new Date(year, month, 1).getDay(); // Day of week (0-6)
        const daysInMonth = new Date(year, month + 1, 0).getDate(); // 28-31
        
        // Render Empty Slots (Previous Month)
        for(let i = 0; i < firstDayIndex; i++) {
            const div = document.createElement('div');
            div.className = 'cal-cell bg-slate-900/30';
            grid.appendChild(div);
        }

        // Render Days
        for(let i = 1; i <= daysInMonth; i++) {
            const dateStr = `${year}-${String(month+1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const div = document.createElement('div');
            div.className = 'cal-cell p-2 cursor-pointer group';
            div.onclick = () => openModal(dateStr);

            // Check if Today
            const todayStr = new Date().toISOString().split('T')[0];
            if(dateStr === todayStr) div.classList.add('cal-today');

            // Day Number
            let html = `<div class="flex justify-between items-start">
                            <span class="day-num text-sm font-semibold text-slate-400 group-hover:text-white">${i}</span>
                            <i class="fas fa-plus text-violet-500 opacity-0 group-hover:opacity-100 text-xs transition"></i>
                        </div>`;

            // Find Events for this Day
            const daysEvents = events.filter(e => e.date === dateStr);
            daysEvents.forEach(ev => {
                const colorClass = ev.type === 'Preventive' 
                    ? 'bg-sky-500/10 text-sky-400 border-sky-500/20' 
                    : 'bg-rose-500/10 text-rose-400 border-rose-500/20';
                
                html += `<div class="mt-1.5 px-2 py-1 rounded border ${colorClass} text-[10px] font-medium truncate">
                            ${ev.title}
                         </div>`;
            });

            div.innerHTML = html;
            grid.appendChild(div);
        }
    }

    // 4. Navigation
    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    // 5. Modal Logic
    function openModal(dateStr) {
        document.getElementById('scheduleModal').classList.remove('hidden');
        document.getElementById('modalDateText').innerText = new Date(dateStr).toDateString();
    }

    function closeModal() {
        document.getElementById('scheduleModal').classList.add('hidden');
    }
</script>
{% endblock %}